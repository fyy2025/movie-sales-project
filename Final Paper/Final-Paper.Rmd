---
title: "Final Paper"
author: "STOR 320.01 Group 17"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidyverse)
library(readr)
library(forcats)
library(ggplot2)
options(scipen=999)
library(tidyverse)    #Loads the tidyverse suite of packages
library(xtable)
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
setwd=("/Users/fanyiyang/Desktop/UNC/Course/Stor320/Final\ Project ")
movie=read_csv("/Users/fanyiyang/Desktop/UNC/Course/Stor320/Final\ Project/movie.csv")
Action=str_detect(movie$Genre,"Action")
Action
movie1=cbind(movie,Action)
str(movie)
names(movie)
movie2=movie%>%
  rename(domestic_sales=names(movie)[6],
         international_sales=names(movie)[7],
         total_sales=names(movie)[8],
         date=names(movie)[5])%>%
  separate(date,into=c("date","year"),sep=",")%>%
  mutate(year=as.numeric(year))
write_csv(movie2,"new_movie.csv")
```
```{r, include=FALSE, message=FALSE, warning=FALSE}
movie3=movie2%>%
  mutate(`Movie Runtime`=str_replace(`Movie Runtime`,"hr",""),
         `Movie Runtime`=str_replace(`Movie Runtime`,"min",""),
         `Movie Runtime`=str_replace_all(`Movie Runtime`," ",""),
         time=as.numeric(`Movie Runtime`),
         minutes=ifelse(time>=100,time%/%100*60+time%%100,ifelse(time>=10,time%/%10*60+time%%10,time*60)))%>%
  dplyr::select(-`Movie Runtime`,-time)
# setwd=("/Users/juliastraight/Desktop//stor 320/Final\ Project")
write_csv(movie3,"New_MOVIE.csv")
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
movie4=movie3%>%
  mutate(Action=ifelse(str_detect(Genre,"Action"),1,0),
         Adventure=ifelse(str_detect(Genre,"Adventure"),1,0),
         `Sci-Fi`=ifelse(str_detect(Genre,"Sci-Fi"),1,0),
         Romance=ifelse(str_detect(Genre,"Romance"),1,0),
         Fantasy=ifelse(str_detect(Genre,"Fantasy"),1,0),
         Animation=ifelse(str_detect(Genre,"Animation"),1,0),
         Family=ifelse(str_detect(Genre,"Family"),1,0),
         Comedy=ifelse(str_detect(Genre,"Comedy"),1,0),
         Musical=ifelse(str_detect(Genre,"Musical"),1,0),
         Crime=ifelse(str_detect(Genre,"Crime"),1,0),
         Drama=ifelse(str_detect(Genre,"Drama"),1,0),
         Thriller=ifelse(str_detect(Genre,"Thriller"),1,0),
         Mystery=ifelse(str_detect(Genre,"Mystery"),1,0),
         Biography=ifelse(str_detect(Genre,"Biography"),1,0),
         Sport=ifelse(str_detect(Genre,"Sport"),1,0),
         Horror=ifelse(str_detect(Genre,"Horror"),1,0),
         total=Action+Adventure+`Sci-Fi`+Romance+Fantasy+Animation+Family+Comedy+Musical+Crime+Drama+Thriller+Mystery+Biography+Sport+Horror)%>%
  separate(Title,into=c("title","year in parenthesis"),sep=-6)
write_csv(movie4,"FINAL_MOVIE.csv")
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
ratio=rep(0,16)
for (i in c(14:29)){
  part=filter(movie4,movie4[i]==1)
  ratio[i-13]=mean(part[["domestic_sales"]]/part[["total_sales"]])
}
names(ratio)=names(movie4)[14:29]
data.frame(as.list(ratio))%>%
  gather(Action:Horror,key=genre,value=rate)%>%
  ggplot()+ ggtitle("Domestic Proportion of Total Sales by Genre") + xlab("Proportion of Total Sales") + ylab("Genre") + 
  geom_bar(stat="identity",aes(y=fct_reorder(genre,ratio),x=rate))
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
movie5=movie4%>%
  mutate(prop=domestic_sales/total_sales)
MEAN_PROP=mean(movie5$prop,na.rm=T)
mean=rep(0,16)
se=rep(0,16)
for (i in c(14:29)){
  part=filter(movie5,movie5[i]==1)
  mean[i-13]=mean(part$prop,na.rm=T)
  se[i-13]=sd(part$prop,na.rm=T)/sqrt(length(part$prop))
}
left_bound=mean-2*se
right_bound=mean+2*se
as.data.frame(cbind(names(movie4)[14:29],mean,se,left_bound,right_bound))%>%
  rename("genre"=`V1`)%>%
  mutate(mean=as.numeric(mean),
         left_bound=as.numeric(left_bound),
         right_bound=as.numeric(right_bound),
         spread=ifelse(left_bound>MEAN_PROP,1,ifelse(right_bound<MEAN_PROP,-1,0)))%>%
  ggplot()+
  geom_errorbar(aes(y=genre,xmin=left_bound,xmax=right_bound,col=as.factor(spread)))+
  geom_vline(xintercept=MEAN_PROP,linetype = "longdash",col="red")+
  geom_point(aes(x=mean,y=genre),fill="white",size=4,shape=21)+
  xlab("domestic sales / total sales")
```
```{r, include=FALSE, message=FALSE, warning=FALSE}
genre_covariance=matrix(NA,16,16)
colnames(genre_covariance)=names(movie4)[14:29]
rownames(genre_covariance)=names(movie4)[14:29]
for (i in c(14:29)){
  genre_specific=filter(movie5,movie5[i]==1)
  mean=rep(0,16)
  se=rep(0,16)
  for (j in c(14:29)){
    part=filter(genre_specific,genre_specific[j]==1)
    mean[j-13]=mean(part$prop,na.rm=T)
    se[j-13]=sd(part$prop,na.rm=T)/sqrt(length(part$prop))
  }
  left_bound=mean-2*se
  right_bound=mean+2*se
  data=as.data.frame(cbind(names(movie4)[14:29],mean,se,left_bound,right_bound))%>%
      rename("genre"=`V1`)%>%
      mutate(mean=as.numeric(mean),
            left_bound=as.numeric(left_bound),
            right_bound=as.numeric(right_bound),
            spread=ifelse(left_bound>MEAN_PROP,1,ifelse(right_bound<MEAN_PROP,-1,0)))
  for (k in c(1:16)){
    genre_covariance[i-13,k]=data$spread[k]
  }
}
genre_covariance
```
```{r, include=FALSE, message=FALSE, warning=FALSE}
as.data.frame(genre_covariance)%>%
  mutate(genre=row.names(.))%>%
  gather(Action:Horror,key="genre2",value="spread")%>%
  ggplot()+
  geom_tile(aes(x=genre2,y=genre,fill=factor(spread)),col="black")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values = c("deepskyblue","lightblue","blue"))+
  geom_abline(a=0,b=1)
```
```{r, include=FALSE, message=FALSE, warning=FALSE}
library(rvest)    
rating=read_csv("https://raw.githubusercontent.com/dineshsonachalam/IMDB_5000_Movies_Statistics_Report-/master/movie_metadata.csv")%>%
  separate(movie_title,into=c("title","no"),sep=-1)%>%
  dplyr::select(title,budget,imdb_score)

movie6= read_csv("/Users/fanyiyang/Desktop/UNC/Course/Stor320/Final\ Project/FINAL_MOVIE.csv")
```
```{r, include=FALSE, message=FALSE, warning=FALSE}
library(purrr)
library(modelr)
movie7=movie6%>%
  mutate(name_length=nchar(title))%>%
  filter(!is.na(date))%>%
  separate(date,into=c("month","day"),sep=" ")%>% #only 800 observations 
  mutate(month=factor(month,unique(month)),
         month=fct_collapse(month,
        Winter=c("December", "January","February"),
        Spring=c("March", "April","May"),
        Summer=c("June", "July","August"),
        Autumn=c("September", "October","November")),
        budget=scale(budget),
        year=scale(year),
        minutes=scale(minutes),
        imdb_score=scale(imdb_score),
        log_domestic=log(domestic_sales),
        )%>%
  dplyr::select(Action:Horror,month,year,minutes,budget,imdb_score,log_domestic)

```


```{r, include=FALSE, message=FALSE, warning=FALSE}
data=crossv_kfold(na.omit(movie7),k=10)
model.func=function(data){
  mod=lm(log_domestic~Action:Horror+month+year+minutes+budget+imdb_score,data=data) # log of domestic
  return(mod)
}
data2=data%>%
  mutate(model=map(train,model.func))
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(broom)
data2.predict=data2%>%
  mutate(predict=map2(.x=test,.y=model,~augment(.y,newdata=.x)))%>%
  dplyr::select(predict)%>%
  unnest()
RMSE.func=function(actual,predict){
  SSE=sum((actual-predict)^2)
  return(sqrt(SSE/length(actual)))
}
INITIAL_RMSE=RMSE.func(data2.predict$log_domestic,data2.predict$.fitted)
INITIAL_RMSE
```
```{r, include=FALSE, message=FALSE, warning=FALSE}
ggplot(data=data2.predict)+
  geom_point(aes(x=.fitted,y=log_domestic))+
  geom_abline(col="red")
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
lm.fit=lm(log_domestic~.,movie7)
coeff=tidy(lm.fit)%>%
  filter(p.value<0.05)%>%
  dplyr::select(term,estimate)
m=model.matrix(log_domestic~.,na.omit(movie7))
model=na.omit(movie7)%>%
  mutate(predict=m[,coeff[[1]]]%*%coeff[[2]])
EIGHT_VARIABLE_RMSE=RMSE.func(model$log_domestic,model$predict)
model%>%
  ggplot()+
  geom_point(aes(x=predict,y=log_domestic))+
  geom_abline(col="red")
EIGHT_VARIABLE_RMSE
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(leaps)
regfit.full=regsubsets(log_domestic~.,data=movie7,nvmax=22)
summary1=summary(regfit.full)
par(mfrow=c(2,2))
plot(summary1$rss,xlab="Number of Variables",ylab="RSS",type="l") #type="l" connects the plotted points with lines
plot(summary1$adjr2,xlab="Number of variables",ylab="Adjusted R^2",type="l")
# I believe 14 variable-model is good enough
best_subset_coef1=coef(regfit.full,14)
m=model.matrix(log_domestic~.,na.omit(movie7))
model2=na.omit(movie7)%>%
  mutate(predict=m[,names(best_subset_coef1)]%*%best_subset_coef1)
model2%>%
  ggplot()+
  geom_point(aes(x=predict,y=log_domestic))+
  geom_abline(col="red")
best_subset_RMSE1=RMSE.func(model2$log_domestic,model2$predict)
best_subset_RMSE1
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
predict.regsubsets=function(object,newdata,id,...){
  form=as.formula(object$call[[2]])
  mat=model.matrix(form,newdata)
  coefi=coef(object,id=id)
  yvars=mat[,names(coefi)]
  return(yvars%*%coefi)
}
set.seed(2)
fold=sample(1:10,nrow(na.omit(movie7)),rep=T)
cv.sse=matrix(NA,10,22,dimnames=list(NULL,paste(1:22)))
for (i in 1:10){
  regfit=regsubsets(log_domestic~.,na.omit(movie7),nvmax=22,subset=(fold!=i))
  for (j in 1:22){
    predict=predict.regsubsets(regfit,na.omit(movie7)[fold==i,],id=j)
    cv.sse[i,j]=mean((na.omit(movie7)$log_domestic[fold==i]-predict)^2)
  }
}
mean.cv.sse=apply(cv.sse,2,mean,drop=T)
mean.cv.sse
plot(mean.cv.sse)
CV.SUBSET.RMSE=sqrt(mean.cv.sse[3])
CV.SUBSET.RMSE
```


```{r, include=FALSE, message=FALSE, warning=FALSE}
library(glmnet)
x=model.matrix(log_domestic~.,na.omit(movie7))[,-1]
y=na.omit(movie7)$log_domestic
lambda_grid=10^seq(10,-2,length=100)
cv.out=cv.glmnet(x,y,alpha=1)
plot(cv.out)
bestLambda=cv.out$lambda.1se
i= which(cv.out$lambda == bestLambda)
bestLambda
best.lasso.fit=glmnet(x,y,alpha=1,lambda=bestLambda)
movie7.predict=na.omit(movie7)%>%
  mutate(predict=predict(best.lasso.fit,newx=x))
movie7.predict%>%
  ggplot()+
  geom_point(aes(x=predict,y=log_domestic))+
  geom_abline(col="red")
lasso_coef=coef(best.lasso.fit)
lasso_coef=lasso_coef[lasso_coef[,1]!=0,]
LASSO_RMSE=RMSE.func(movie7.predict$predict,movie7.predict$log_domestic)
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
set.seed(20)
library(glmnet)
x=model.matrix(log_domestic~.*.,na.omit(movie7))[,-1]
y=na.omit(movie7)$log_domestic
lambda_grid=10^seq(10,-2,length=100)
cv.out=cv.glmnet(x,y,alpha=1)
plot(cv.out)
bestLambda=cv.out$lambda.1se
i= which(cv.out$lambda == bestLambda)
best.lasso.interaction.fit=glmnet(x,y,alpha=1,lambda=bestLambda)
movie7.predict=na.omit(movie7)%>%
  mutate(predict=predict(best.lasso.interaction.fit,newx=x))
movie7.predict%>%
  ggplot()+
  geom_point(aes(x=predict,y=log_domestic))+
  geom_abline(col="red")
lasso_coef=coef(best.lasso.interaction.fit)
lasso_interaction_coef=lasso_coef[lasso_coef[,1]!=0,]
lasso_interaction_coef
LASSO_INTERACTION_RMSE=RMSE.func(movie7.predict$predict,movie7.predict$log_domestic)
```


```{r, include=FALSE, message=FALSE, warning=FALSE}
domestic_models=tribble(
  ~model, ~RMSE,  ~variables,
  "lm", INITIAL_RMSE,  23,
  "lm2", EIGHT_VARIABLE_RMSE,  8,
  "Best Subset", best_subset_RMSE1, 14,
  "CV Best Subset", CV.SUBSET.RMSE, 3,
  "Lasso", LASSO_RMSE , 4,
  "Lasso with interaction", LASSO_INTERACTION_RMSE, 11
  )
domestic_models
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
movie8=movie6%>%
  mutate(name_length=nchar(title))%>%
  filter(!is.na(date))%>%
  separate(date,into=c("month","day"),sep=" ")%>% #only 800 observations 
  mutate(month=factor(month,unique(month)),
         month=fct_collapse(month,
        Winter=c("December", "January","February"),
        Spring=c("March", "April","May"),
        Summer=c("June", "July","August"),
        Autumn=c("September", "October","November")),
        budget=scale(budget),
        year=scale(year),
        minutes=scale(minutes),
        imdb_score=scale(imdb_score),
        log_international=log(international_sales))%>%
  dplyr::select(Action:Horror,month,year,minutes,budget,imdb_score,log_international)
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(leaps)
regfit.full=regsubsets(log_international~.,data=movie8,nvmax=22)
summary1=summary(regfit.full)
par(mfrow=c(2,2))
plot(summary1$rss,xlab="Number of Variables",ylab="RSS",type="l") #type="l" connects the plotted points with lines
plot(summary1$adjr2,xlab="Number of variables",ylab="Adjusted R^2",type="l")
# I believe 14 variable-model is good enough
best_subset_coef2=coef(regfit.full,20)
m=model.matrix(log_international~.,na.omit(movie8))
model2=na.omit(movie8)%>%
  mutate(predict=m[,names(best_subset_coef2)]%*%best_subset_coef2)
model2%>%
  ggplot()+
  geom_point(aes(x=predict,y=log_international))+
  geom_abline(col="red")
best_subset_RMSE2=RMSE.func(model2$log_international,model2$predict)
best_subset_RMSE2
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
x=model.matrix(log_international~.*.,na.omit(movie8))[,-1]
y=na.omit(movie8)$log_international
lambda_grid=10^seq(10,-2,length=100)
cv.out2=cv.glmnet(x,y,alpha=1)
plot(cv.out2)
bestLambda=cv.out2$lambda.1se
i=which(cv.out2$lambda==bestLambda)
best.lasso.interaction.fit2=glmnet(x,y,alpha=1,lambda=bestLambda)
movie8.predict=na.omit(movie8)%>%
  mutate(predict=predict(best.lasso.interaction.fit2,newx=x))
movie8.predict%>%
  ggplot()+
  geom_point(aes(x=predict,y=log_international))+
  geom_abline(col="red")
lasso_coef2=coef(best.lasso.interaction.fit2)
lasso_interaction_coef2=lasso_coef2[lasso_coef2[,1]!=0,]
lasso_interaction_coef2
LASSO_INTERACTION_RMSE2=RMSE.func(movie8.predict$predict,movie8.predict$log_international)
```

# INTRODUCTION
  Beginning in 1914, filmmaking exploded with the rise of independant film distributors -- more than 4,200 new films were created that year. American filmmaking grew rapidly over the next century, catering to a diverse market that crosses racial, ethnic and political lines. In 1930, more than 65% of Americans saw a movie at least once a week. Movies have become a dominant part of American and international leisure time (Croteau et al. 2021).
  
  In our research, we focused on the top 1000 highest grossing hollywood films. As a technology of entertainment, movies are not just attractive images; they are a result of an industry driven by market forces (Croteau et al. 2021). All of the pieces of a movie are carefully and purposefully designed, including the title, runtime, and genre. Movies and movie genres perform differently in different regions, and these elements are closely related to the ultimate profits of the film. 

  The two research questions discussed in this paper are: 

  1. How do different genres and combinations of genres influence the preference ratio of domestic sales over total sales of movies? 

  2. Is there a difference in the international and domestic preference of movie attributes?

  Movies have various genres, including: action, comedy, family, science fiction, and romance. Different countries have their own styles and areas of expertise in the film industry; Japan and Thailand are famous for their thriller movies, while the United States is definitely leading the world in science fiction films. Furthermore, some other variables such as the **budget**, **minutes**, **month**, and **imdb_score** also have a great influence on how well a movie performs. These factors piqued our curiosity about the consistency of  **international** and **domestic sales**. These questions can help us understand the disparity between domestic and international preference.
  
  Advertising and exporting films globally requires a large investment, and sometimes the return on those investments are low. This research can help filmmakers and decide where and how to advertise their films based on the attributes of the film. A better understanding of the preferences of certain populations can help people in the film industry make wise investment decisions. With the results of this research, we can help the movie industry maximize profits and allow consumers better access to movies that interest them the most 

# DATA

  While the overall premise of our data is easy to understand, how it was compiled and added together gives it a layer of complexity. The data we used was compiled by Sanjeet Singh Naik, a student at the KJ Somaiya College of Engineering in India. The data itself has been scraped from multiple movie rating sources, including IMDb and Rotten Tomatoes. The dataset contains information about the top 1000 highest grossing Hollywood films and their specific production and rating stats, and is up to date as of January this year. 
  
  We then merged our original 1000 movie dataset with another dataset entitled “IMDb ratings for 5000 movies” using title as the key. This new data was compiled by Dinesh Sonachalam, a Software Developer at Gogoair, and was scraped directly from the IMDb website. We performed this operation so that we would be able to see the IMDb ratings for the selected movies and have a metric to measure popularity by.  
To answer our two questions, we narrowed down the variables in the data set instead of focusing on all of them. 

The table below lists the relevant variables for the first 10 movies in the data set, with each row representing the statistics and information for a single movie. To start off with the categorical variables, these included **Title**, **Month** and **Genre**. For the purpose of our question, **Genre** was an especially important variable and it included 16 different categories ranging from Action to Romance. The **Month** variable displays whether the movie was release in the Winter, Spring, Summer, or Autumn. The **Title** allowed us to look at the words and length of the title. 
  In terms of quantitative variables, the specific variables we looked at were **Year**, **Dom**, **Intl**, **IMDb**, and **Budget**. **Dom** and **Intl** represents the domestic sales and international sales respectively in million dollars. The **IMDb** gives the movie an overall rating out of ten, and these ratings are averaged from the votes of all IMDb users. Lastly, **Budget** represents the money allotted for the movie, and includes production, advertising, marketing, and other miscellaneous costs, in million dollars. 

### Head of Movie Dataset
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
displaydata <- na.omit(movie6)%>%
  mutate(Budget=budget/1000000) %>%
mutate(Dom=domestic_sales/1000000) %>%
mutate(Global=total_sales/1000000) %>%
mutate(Intl=international_sales/1000000) %>%
rename(Runtime=minutes,
       IMDb=imdb_score,
       Year=year,
       Title=title)%>%
  filter(!is.na(date))%>%
  separate(date,into=c("month","day"),sep=" ")%>% #only 800 observations 
  mutate(Month=factor(month,unique(month)),
         Month=fct_collapse(month,
        Winter=c("December", "January","February"),
        Spring=c("March", "April","May"),
        Summer=c("June", "July","August"),
        Autumn=c("September", "October","November")),
        log_international=log(international_sales)) %>%
  select(Title, Month, Year, Budget, IMDb, Dom, Intl,Genre)

displaydata=displaydata %>%
  head(10) %>%
  xtable(digits=c(0,0,0,0,1,1,1,1,2))
align(displaydata)="p{0.1cm}p{0.1cm}p{0.1cm}p{0.1cm}ccp{0.2cm}||rc"

print(displaydata,type="html",include.rownames=F,
      html.table.attributes="align='center',
                             rules='rows',
                             width=100%,
                             frame='hsides',
                             border-spacing=5px"
                            )
```
  
  <br>
  
  Other non-central variables include **total sales**, **minutes**, **movie info**, and **distributors**. **total sales** is particularly interesting as it gives us the opportunity to learn about the ratio of domestic to international sales for specific movies. **minutes** indicates how long the movie ran for, and we modified this variable so that all the values were represented in minutes. The **movie info** provided a brief paragraph introduction to each movie and the **distributor names** listed out which company was responsible for the marketing of the film. We did not include these variables in the table because they were not as relevant in answering our two questions. 
  
  To answer our questions, we created several variables in the data set. We created a **ratio** variable to represent the proportion of domestic sales over total sales. We also created the **Month** variable from the original data about release date. We used the factor function to make a month a factor variable with four values: spring, summer, autumn, and winter to refer to the season the movies were released. We denoted December to February as winter, March to May as spring, June to August as summer, and September to November as autumn. Finally, we created **log_domestic** and **log_international** to have the log value of movie sales because we wanted to predict sales with linear models. We also created 16 indicator variables from the **Genre** variable. These variables noted which genres each movie belongs to. 
  
Our data visualization figure, shown below, describes differences in distribution of **international sales** and **domestic sales**, displayed in millions of dollars. The distribution is generally the same for both categories, but their values vary greatly. The sky blue line shows the **domestic sales**, which is much higher than **international sales** from around $100 million to $200 million in sales, and then drops below **international sales** from around $300 million through $1 billion in sales. The darker blue line represents **international sales**, which are more evenly spread than **domestic sales**. 


```{r, echo=FALSE, message=FALSE, warning=FALSE}
Type=c("domestic"="skyblue","international"="blue")
movie4%>%
  mutate(domestic=domestic_sales/1000000,
         international=international_sales/1000000)%>%
  ggplot()+
  ggtitle("Domestic and International Movie Frequency") +
  geom_freqpoly(aes(x=domestic,color="domestic"),alpha=1)+
  geom_freqpoly(aes(x=international,color="international"),alpha=0.5)+
  labs(x="Sales (million dollars)",
       y="Number of Movies",
       colour="Type of Sales")+
  scale_color_manual(values = Type)
```

<br>

# RESULTS
### **First Question**
  The first question we have is how different genres and combinations of genres influence the proportion of **domestic sales** over **total sales** of the movies in our dataset. To work on this question, we subsetted the dataset to include only movies with certain genres, and then generated the 95% confidence intervals of the proportion of **domestic sales** over **total sales** (we will refer to this variable as **ratio** in the following context) by calculating means and standard errors of the ratio for each movie genre. We first made a graph of the confidence intervals for the 16 genres as shown below. The x-intercept of the red dashed line represents the overall average ratio, which is `r MEAN_PROP`. From this process, we found that some genres had significantly larger or smaller ratios than the average, with their confidence intervals lying completely left of the vertical line (which represents the overall average). This finding means they performed better outside of America than the average movie in our dataset. Other confidence intervals include the average, and some lie completely to the right of the average. 
  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
movie5=movie4%>%
  mutate(prop=domestic_sales/total_sales)
MEAN_PROP=mean(movie5$prop,na.rm=T)
mean=rep(0,16)
se=rep(0,16)
for (i in c(14:29)){
  part=filter(movie5,movie5[i]==1)
  mean[i-13]=mean(part$prop,na.rm=T)
  se[i-13]=sd(part$prop,na.rm=T)/sqrt(length(part$prop))
}
left_bound=mean-2*se
right_bound=mean+2*se
as.data.frame(cbind(names(movie4)[14:29],mean,se,left_bound,right_bound))%>%
  rename("genre"=`V1`)%>%
  mutate(mean=as.numeric(mean),
         left_bound=as.numeric(left_bound),
         right_bound=as.numeric(right_bound),
         spread=ifelse(left_bound>MEAN_PROP,1,ifelse(right_bound<MEAN_PROP,-1,0)))%>%
  ggplot()+
  ggtitle("Confidence Interval for Proportions")+
  geom_errorbar(aes(y=genre,xmin=left_bound,xmax=right_bound,col=as.factor(spread)))+
  geom_vline(xintercept=MEAN_PROP,linetype = "longdash",col="red")+
  geom_point(aes(x=mean,y=genre),fill="white",size=4,shape=21)+
  xlab("Domestic Sales / Total Sales")+
  ylab("Genre")+
  scale_color_manual(name = "Confidence Interval \nRelationship with Overall Mean", labels = c("smaller", "contains", "greater"),values = c("deepskyblue","lightblue3","blue"))
```
 <br>
  We then tried to compare different combinations of genres. By subsetting all possible pairs of genres, we generated new confidence intervals and compared them with the overall mean. Finally, we were able to generate this graph of the interaction of genres. The color of squares on the tile graph represents the relationship between the confidence interval and the overall average ratio. The black line has slope of 1 and y intercept of 0. All the squares that the black line passes through indicate the relationship with the overall mean for only one genre. The whole graph is symmetric across the black line. From this graph, we could tell that different combinations of genres do have a great influence on the ratio. While Animation and Action movies see a majority of their ratios significantly smaller than the average in combination with the other 15 genres, other genres have a different relationship between confidence intervals and overall mean when subset with other genres. For example, the Romance and Musical genres generally contain the average.

  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(genre_covariance)%>%
  mutate(genre=row.names(.))%>%
  gather(Action:Horror,key="genre2",value="spread")%>%
  ggplot()+
  ggtitle("Genre Interaction Plot") +
  geom_tile(aes(x=genre2,y=genre,fill=factor(spread)),col="black")+
  theme(axis.text.x = element_text(angle = 90))+
  geom_abline(a=0,b=1)+
  xlab("First Genre")+
  ylab("Second Genre")+
  scale_fill_discrete(name = "Confidence Interval Relationship with Overall Means", labels = c("smaller", "contains", "greater"))+
  scale_fill_manual(name = "Confidence Interval \nRelationship with Overall Mean", labels = c("smaller", "contains", "greater","no data"),values = c("deepskyblue","lightblue3","blue"))
```

<br>
  
  
### **Second Question**

  The second question of our group project is whether there is a difference between the international and domestic preference of movie types. We decided to use **domestic sales** and **international sales** statistics primarily to evaluate the popularity of movies. We saw in the second data visualization figure that there is a large difference between international and domestic sales, so we decided to look closer at that relationship. To start with, we tried to find the best modeling method to predict sales. We started with **domestic sales**. We filtered the dataset to have 23 variables (16 indicator variables for genres, **minutes**, **budget**, **year**, **imdb_score**, three indicator variables for **month**) to predict the domestic sales. We first scaled the non-indicator variables **year**, **minutes**, **imdb_score**, and **budget** to prepare for building models. We tried the linear model and found out that the relationship between domestic sales and any other variable is far from linear. We then decided to switch to predict the log value of domestic sales. We first used the simplest linear model and got a root mean secured error(RMSE) of `r INITIAL_RMSE`. Then, we tried to get rid of the unimportant variables. After viewing the summary of our linear model, we selected only the coefficients of variables whose p-values were smaller than 0.05 (indicating that they were statistically significant in the model). This model included eight variables (**Adventure**, **Sci-Fi**, **Fantasy**, **monthSummer**, **monthSpring**, **budget**, **imdb_score**) and did slightly better with an RMSE of `r EIGHT_VARIABLE_RMSE`. 
  
  Consequently, we changed to the ‘best subset’ method to filter variables, in which the computer runs through every possible combination of variables and calculates the models’ RMSEs. The result showed the model with 14 variables produced a really small RMSE value of `r best_subset_RMSE1`. The 22-variable model had the best RMSE, but we chose the simpler model of 14 variables. Additionally, we tried another model using cross validation in the best subset. We split the data into 10 parts and used 9 parts to generate models with the best subset to predict the last one part. Then, we calculated the overall RMSE of the model. The result of this approach is similar to the best subset one. Though RMSE gets slightly smaller for including all variables, we found that the 3-variable model also had a nice RMSE in this case. So, we chose the 3-variable model which had an RMSE of `r CV.SUBSET.RMSE`. 
  
  Finally, we tried to use shrinkage estimation methods to get rid of variables. We tried lasso regression for 100 different lambda values from 10^-2 to 10^10 and chose the model with the largest value of lambda such that error is within 1 standard error of the minimum to eliminate more variables while keeping the model accurate. This model had an RMSE of `r LASSO_RMSE` and 11 variables in it. So far, the ‘best subset’ model gave us the best RMSE. However, from our first question, we knew that the genres might strongly interact with each other, and including interaction in our model is going to help. Unfortunately, the interaction can’t work out with the ‘best subset’ model since there were too many calculations. As a result, we turned to add interaction in the lasso model. This final model we had included 11 variables and an RMSE of `r LASSO_INTERACTION_RMSE`. It makes sense that the model using lasso with interaction was better than the original lasso model because our first question concluded that genres interact with each other strongly. This table shows the comparison of numbers of variables and RMSE for all of our 6 models. ‘Best subset’ is the best model so far with the smallest RMSE, so we are using it to predict both domestic and international sales.


### Model Comparison Table  
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
domestic_models=tribble(
  ~model, ~RMSE,  ~variables,
  "Linear Model", INITIAL_RMSE,  23,
  "Linear Model with 8 Chosen Variables", EIGHT_VARIABLE_RMSE,  8,
  "Best Subset", best_subset_RMSE1, 14,
  "Cross Validation Best Subset", CV.SUBSET.RMSE, 3,
  "Lasso", LASSO_RMSE , 4,
  "Lasso with Interaction", LASSO_INTERACTION_RMSE, 11
  )

domestic_models=domestic_models %>%
  xtable(digits=c(0,6,6,0))
align(domestic_models)="cccc"
print(domestic_models,type="html",include.rownames=F,
      html.table.attributes="align='center',
                             rules='rows',
                             width=75%,
                             frame='hsides',
                             border-spacing=5px"
      )

```

  <br>
  
  After generating models with 'Best Subset' for the log value of **domestic** and **international sales** respectively, we compared the models to see the different preferences of domestic and international audiences. We listed the respective variables and their coefficients for the two models. Genres were a big part of our variables. We found that all the variables that existed in both models except for **Animation** had the same sign (**Action**, **Adventure**, **Musical**, **Fantasy**, **Drama**), meaning that on average international and domestic audiences have the same intention to like (**Adventure**, **Musical**, **Fantasy**) or dislike (**Action**, **Drama**, **Biography**) when compared to other genres in our dataset. For Animation movies, domestic audiences like them less while international audiences prefer them more. Additionally, American people like Sci-Fi, Mystery, and Biography as they only appear in the domestic model, while international viewers like Romance and Thriller movies more and Crime, Sports, Biography, Family, and Comedy movies less. Other than genres, both **domestic** and **international sales** increase as **minutes**, **budget**, and **imdb_score** increase. This makes sense because longer movies with larger budgets and higher ratings tend to attract a larger audience and receive better sales. **Year** is only an important variable for international sales. Hollywood has become more and more internationally prevalent since 1972 (which is when the oldest movie in our data set was released) and people from more countries have had access to Hollywood movies. Finally, audiences from all around the world prefer watching movies released in spring and summer rather than those in other seasons. And while Americans like spring movies more, international consumers love to watch movies in autumn as well. 

### Coefficient Comparison Table
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
coef1=cbind(names(best_subset_coef1),best_subset_coef1)
coef1=as.tibble(coef1)%>%
  rename("Variable"="V1",
         "coefficient"="best_subset_coef1")
coef2=cbind(names(best_subset_coef2),best_subset_coef2)
coef2=as.tibble(coef2)%>%
  rename("Variable"="V1",
         "coefficient"="best_subset_coef2")

coef=full_join(coef1,coef2,by="Variable")%>%
  rename("Domestic"="coefficient.x","International"="coefficient.y")%>%
  mutate(Domestic=ifelse(is.na(Domestic),0,Domestic),
         International=ifelse(is.na(International),0,International),
         Domestic=as.numeric(Domestic),
         International=as.numeric(International))%>%
  rename(Domestic_model=Domestic,
         International_model=International)%>%
  xtable(digits=c(0,4,4,4))
align(coef)="cccc"
print(coef,type="html",include.rownames=F,
      html.table.attributes="align='center',
                             rules='rows',
                             width=50%,
                             frame='hsides',
                             border-spacing=5px"
      )
```

<br>

# CONCLUSION

  The first question of our group project is: How do different genres and combinations of genres influence the proportion of domestic sales over total sales of movies? We subsetted the dataset to look at confidence intervals of proportions and compared them with the overall mean proportion. Some intervals lie completely to the right, others lie completely to the left, and some contain the average. Then we subsetted the data to look at confidence intervals of proportions for movies with two genres and again compared them with the overall mean. The result revealed that the relationship between confidence intervals and the overall mean for almost all genres changed when they are paired with different genres. This tells us that different combinations of genres greatly influence the proportion of domestic sales over total sales. Preferences of domestic and international audiences change greatly for different pairs of genres.
  
  The second question we have is: Is there a difference in the international and domestic preference of movie attributes? We used **domestic sales** and **international sales** statistics primarily to evaluate the popularity of movies. After trying 6 different models and applying the best one, Best Subset, to predict domestic and international sales, it is not surprising to see that there are great differences between the preferences of American audiences and the rest of the world. International and domestic audiences have their own preferences, and the most extreme example of this is Animation. International audiences greatly prefer Animation, while domestic audiences do not. Most genres are significant for either domestic or international audiences and not significant for the other audience. 
  
  Our findings are significant for data analysis and modeling and can certainly be used in the real world. We have effectively shown that there are multiple factors that reflect sales correlations between movies, and these correlations could be used to guide future decisions in movie-making and marketing. We found that a correlation exists between genre combinations and the ratio of domestic sales over international sales. Furthermore, we discovered how many variables correlate with the sales of a movie. We also found that audiences prefer certain genres based on whether the audience is domestic or international. Both the domestic and international sales increase along with **minutes**, **budget**, and **imdb_score**. It is reasonable that audiences are more willing to choose a higher rated and longer film with a larger budget. Our geographic correlations include that American people like Sci-Fi, Mystery and Biography; and international consumers like romance and thriller movies more. Global audiences from prefer watching spring and summer movies, Americans prefer spring movies, and international consumers prefer autumn movies.
  
  There are always more ways to perfect our modeling to produce the most accurate data. One way to effectively do this is to increase our sample size. Our sample size of 1,000 movies is enough to produce valid data, but it is certainly not enough for professional data analysis. Moreover, our data includes the 1,000 movies with the highest domestic sales, which will skew the data in favor of movies that are preferred in America. If the sales per movie were more randomized, we could have more accurate data analysis conclusions. When we were calculating the confidence intervals of movies with different combinations of genres, some intervals were not accurate due to the limited size of the sample. If we had access to data that could allow us to increase our data set to 5,000 movies, that would make our data and modeling more precise. Another method that we could incorporate would be inflation. Especially when comparing sales between movies from 1970 to 2019, there is certainly a difference in the amount each ticket is worth over the years. A profit of $50 million in 1970 would be worth closer to $370 million in 2019. To improve this, we need to compare the average movie ticket price for each year and use that as a reference of our sales data. Further, we have been using IMDB scores found online to predict both domestic and international sales. However, IMDB is a website open to audiences from all over the world. While there might be some differences between opinions from America and other countries, using global rating scores might be inappropriate on this occasion. To improve our data, we could use a more centralized review system such as a particular professional film critic’s numeric review.
  
  Lastly, we cannot evaluate the popularity or success of movies solely based on sales. There are many factors that go into the sales of a movie: expectation, advertising, release date, the director, the leading actors and actresses, the producer, etc. Sales of a movie do not show the whole story of whether a movie is popular or successful. Thus, we should consider more variables and methods in order to better convey what movies are able to yield success. One way would be to compare the rate of sales over the movie budget. For instance, we can create a variable to represent the percentage of net income made by the movies. This would convey if a movie is more successful than another in a different way. Assessing success in a few different ways and then comparing those successes could help us determine which movies are overall most successful. A production company with a significantly smaller budget than another company could produce a movie with smaller sales but this does not necessarily mean the bigger budget movie is more successful -- the smaller budget movie could have a much higher profit margin. Another improvement we could include would be incorporating the interaction variables for the genre variables. This would create more accurate data when we use the model to predict sales. However, we cannot include the interaction variables in 'Best Subset' because it would result in too much calculation for R. It would be beneficial to look at this dataset or a similar one with more powerful data analysis technology in order to see a fuller picture of the success of Hollywood movies.








